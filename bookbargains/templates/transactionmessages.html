{% extends "base.html" %}
{% load static %}
{% block body_block %}

<div class="jumbotron pt-3 pb-0 mt-0 mb-0" style="background-color: transparent; border-radius:0px">
    <div class="row mt-5 text-center">
        <div class="col-2"></div>
        <div class="col-2" style="align-self:center;">
            <a class="btn btn-outline-dark" href="{% url 'viewmytransactions' %}">See All Transactions</a>
        </div>
        <div class="col-4">
            <h3 class="display-5" style="color:#8a100b; font-family: 'Oswald', sans-serif; font-size: 2em;">MESSAGING 
                {% if transaction.buyer == request.user %}
                    {{transaction.seller}}
                {% else %}
                    {{transaction.buyer}}
                {% endif %}
            </h3>
        </div>
        <div class="col-4"></div>
    </div>
</div>

<div class="container mt-5 mb-5">
    <div class="row">
        <div class="col-4">
            <div class="card">
                <img class="card-img-top" src="{{transaction.book.image.url}}" alt="">
                <div class="card-body">
                    <h5 class="card-title text-center">{{transaction.book.title}}</h5>
                    <ul class="text-center list-group list-group-flush">
                        <li class="list-group-item">Owner: {{transaction.book.user.username}}</li>
                        <li class="list-group-item">Author: {{transaction.book.author}}</li>
                        <li class="list-group-item">ISBN: {{transaction.book.ISBN13}}</li>
                        <li class="list-group-item">Edition: {{transaction.book.edition}}</li>
                        <li class="list-group-item">Condition: {{transaction.book.get_condition_display}}</li>
                        <li class="list-group-item">Field: {{transaction.book.get_field_display}}</li>
                        <li class="list-group-item">Price: {{transaction.book.price}}</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-8">
            {% if transactionmessages %}
                {% if transaction.get_status_display == 'Completed' %}<p></p>
                {% else %}
                    <div class="container text-right">
                        <p class="p-1">
                            <span><a href="{% url 'donewithtransaction' doneusername=request.user.username transactionid=transaction.uuid %}" class="btn btn-dark">Transaction is DONE!</a></span>
                        </p>
                    </div>
                {% endif %}

                {% for m in transactionmessages %}
                    {% if m.sender == request.user %}
                        <div class="d-flex flex-row justify-content-end p-3 my-1 mx-3 rounded" style="position: relative; background-color: #ebcea5;">
                            <div class="triangle top-right"></div>
                            <div class="mr-1 p-1">{{m.text}}</div>
                            <img src="https://img.icons8.com/color/48/000000/circled-user-male-skin-type-7.png" width="30" height="30">
                        </div>
                    {% else %}
                        <div class="d-flex flex-row p-3 my-1 mx-3 rounded" style="position: relative; background-color: #c4a57b;">
                            <div class="triangle top-left"></div>
                            <img src="https://img.icons8.com/color/48/000000/circled-user-female-skin-type-7.png" width="30" height="30">
                            <div class="chat ml-2 p-1">{{m.text}}</div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p class="text-center" style="color: #8a100b; font-family: 'Oswald', sans-serif; font-size: 1.5em;">No messages have been exchanged yet.</p>
            {% endif %}

            {% if transaction.get_status_display == 'Completed' %}<p class="text-center mt-2" style="color:#8a100b; font-family: 'Oswald', sans-serif; font-size: 1.5em;">The transaction is complete.</p>
            {% else %}
                <form class="mt-3" method="post" class="w-50 m-auto">
                    {% csrf_token %}
                    {% for field in form %}
                        <p class="w-75 m-auto" id="{{ field.name }}">
                        {{field}}
                        {% if field.help_text %}
                            <small style="color: grey">{{ field.help_text }}</small>
                        {% endif %}
                        {% for error in field.errors %}
                            <p style="color: red">{{ error }}</p>
                        {% endfor %}
                        </p>
                    {% endfor %}
                    <div class="text-center mt-4"><button class="text-center btn btn-dark" type="submit">Send Message</button></div>
                </form>
            {% endif %}
        </div>
    </div>
</div>


{% endblock %}

